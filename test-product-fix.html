<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Product Selection Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .test-panel { background: white; padding: 20px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .info { border-color: #17a2b8; background: #d1ecf1; }
        
        /* Copy relevant styles for testing */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: bold; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .search-results { background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; display: none; position: absolute; z-index: 1000; width: 100%; }
        .search-result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-result-item:hover { background: #f8f9fa; }
        .product-result-code { font-weight: bold; color: #007bff; }
        .product-result-description { color: #666; font-size: 14px; }
        .product-result-details { color: #999; font-size: 12px; margin-top: 2px; }
        
        .customer-result-name { font-weight: bold; color: #007bff; }
        .customer-result-details { color: #666; font-size: 12px; }
        
        .test-form { max-width: 500px; position: relative; }
    </style>
</head>
<body>
    <h1>🧪 Product Selection Fix Test</h1>
    
    <div id="status" class="test-panel info">
        <strong>Status:</strong> Loading test environment...
    </div>
    
    <div class="test-panel">
        <h3>Test Form</h3>
        <div class="test-form">
            <div class="form-group">
                <label class="form-label">Müşteri Adı</label>
                <input type="text" id="customer-name" class="form-input" placeholder="Müşteri adını girin..." autocomplete="off">
                <div id="customer-search-results" class="search-results"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ürün Kodu veya Adı</label>
                <input type="text" id="product-search" class="form-input" placeholder="Kod girin veya ada göre arayın..." autocomplete="off">
                <div id="search-results" class="search-results"></div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Miktar</label>
                <input type="number" id="quantity-visible" class="form-input" value="1" min="1" max="999" onchange="document.getElementById('quantity').value = this.value;">
            </div>
            
            <div class="form-group">
                <label class="form-label">Notlar (Test)</label>
                <textarea id="item-notes-visible" class="form-input" rows="2" placeholder="Test notları..." onchange="document.getElementById('item-notes').value = this.value;"></textarea>
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="testCustomerSearch()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    Test Customer Search
                </button>
                <button onclick="testProductSearch()" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    Test Product Search  
                </button>
                <button onclick="testSelectProduct()" style="padding: 8px 16px; background: #6f42c1; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    Test Select Product
                </button>
                <button onclick="testDropdownClick()" style="padding: 8px 16px; background: #fd7e14; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                    Test Dropdown Click
                </button>
                <button onclick="testAddItem()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Test Siparişe Ekle
                </button>
            </div>
        </div>
        
        <!-- Add missing DOM elements that orderManager expects -->
        <div style="display: none;">
            <!-- Order summary elements that updateOrderSummary() needs -->
            <span id="summary-customer">-</span>
            <span id="total-items">0</span>
            <span id="total-metal-weight">0.00g</span>
            <span id="total-stone-weight">0.00g</span>
            <span id="total-weight">0.00g</span>
            <span id="order-date"></span>
            
            <!-- Order summary and actions containers -->
            <div id="order-summary"></div>
            <div id="order-actions"></div>
            <div id="order-items"></div>
            
            <!-- Missing input fields that addItem() method needs -->
            <input type="number" id="quantity" value="1" min="1" max="999">
            <textarea id="item-notes" placeholder="Test notes"></textarea>
            
            <!-- Product preview element -->
            <div id="product-preview"></div>
        </div>
    </div>
    
    <div id="test-results" class="test-panel">
        <h3>Test Results</h3>
        <div id="test-output">Running tests...</div>
    </div>

    <!-- Include the actual scripts with updated cache busting -->
    <script src="js/database.js?v=1750755300"></script>
    <script src="js/customerDatabase.js?v=1750755268"></script>
    <script src="js/orderManager.js?v=1750755600"></script>
    
    <script>
        let testResults = [];
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = `<strong>Status:</strong> ${message}`;
            status.className = `test-panel ${type}`;
        }
        
        function addTestResult(test, result, type = 'info') {
            testResults.push(`<div class="${type}"><strong>${test}:</strong> ${result}</div>`);
            document.getElementById('test-output').innerHTML = testResults.join('');
        }
        
        function testCustomerSearch() {
            const customerInput = document.getElementById('customer-name');
            customerInput.value = 'Kerem';
            customerInput.focus();
            
            // Trigger input event
            const event = new Event('input', { bubbles: true });
            customerInput.dispatchEvent(event);
            
            addTestResult('Customer Search Test', '✅ Triggered search for "Kerem" - check dropdown', 'success');
        }
        
        function testProductSearch() {
            console.log('🧪 Testing product search...');
            
            // Check customer selection first
            console.log('🧪 Customer check - name:', orderManager?.currentOrder?.customerName);
            console.log('🧪 Customer check - ID:', orderManager?.currentOrder?.customerId);
            
            if (!orderManager?.currentOrder?.customerId) {
                console.log('🧪 No customer selected, selecting first customer...');
                if (typeof customerDatabase !== 'undefined' && customerDatabase.customers.length > 0) {
                    const firstCustomer = customerDatabase.customers[0];
                    console.log('🧪 About to select customer:', firstCustomer);
                    orderManager.selectCustomer(firstCustomer.id);
                    console.log('🧪 Auto-selected customer:', firstCustomer.name);
                    
                    // Verify the selection worked
                    console.log('🧪 After selection - customerName:', orderManager?.currentOrder?.customerName);
                    console.log('🧪 After selection - customerId:', orderManager?.currentOrder?.customerId);
                } else {
                    console.log('🧪 No customers available for auto-selection');
                }
            } else {
                console.log('🧪 Customer already selected:', orderManager.currentOrder.customerName);
            }
            
            // Check if productDatabase is available and has products
            if (typeof productDatabase === 'undefined') {
                addTestResult('Product Search Test', '❌ productDatabase not available', 'error');
                return;
            }
            
            console.log('🧪 productDatabase.products.length:', productDatabase.products.length);
            console.log('🧪 productDatabase.products:', productDatabase.products);
            
            if (productDatabase.products.length === 0) {
                addTestResult('Product Search Test', '❌ No products in database', 'error');
                return;
            }
            
            // Test the search functionality
            const testSuggestions = productDatabase.getProductSuggestions('KP');
            console.log('🧪 getProductSuggestions("KP") returned:', testSuggestions);
            
            const productInput = document.getElementById('product-search');
            productInput.value = 'KP';
            productInput.focus();
            
            // Wait a bit for customer selection to fully process, then trigger product search
            setTimeout(() => {
                console.log('🧪 Final check before triggering input event:');
                console.log('🧪 Final customerName:', orderManager?.currentOrder?.customerName);
                console.log('🧪 Final customerId:', orderManager?.currentOrder?.customerId);
                
                // Trigger input event  
                const event = new Event('input', { bubbles: true });
                productInput.dispatchEvent(event);
                
                addTestResult('Product Search Test', `✅ Triggered search for "KP" - found ${testSuggestions.length} products`, 'success');
            }, 100);
        }
        
        function testSelectProduct() {
            console.log('🧪 Testing direct product selection...');
            
            if (!orderManager) {
                addTestResult('Test Select Product', '❌ orderManager not available', 'error');
                return;
            }
            
            if (typeof productDatabase === 'undefined' || productDatabase.products.length === 0) {
                addTestResult('Test Select Product', '❌ No products available', 'error');
                return;
            }
            
            // Try to select the first product directly
            const firstProduct = productDatabase.products[0];
            console.log('🧪 Attempting to select product:', firstProduct);
            
            try {
                orderManager.selectProductFromSearch(firstProduct.code);
                addTestResult('Test Select Product', `✅ Attempted to select ${firstProduct.code}`, 'success');
                
                // Check if it worked
                setTimeout(() => {
                    if (orderManager.selectedProduct) {
                        addTestResult('Product Selection Result', `✅ selectedProduct is now: ${orderManager.selectedProduct.code}`, 'success');
                    } else {
                        addTestResult('Product Selection Result', '❌ selectedProduct is still null', 'error');
                    }
                }, 100);
            } catch (e) {
                addTestResult('Test Select Product', `❌ Error: ${e.message}`, 'error');
            }
        }
        
        function testDropdownClick() {
            console.log('🧪 Testing dropdown click simulation...');
            
            // Check customer selection first
            console.log('🧪 Current order state:', orderManager?.currentOrder);
            console.log('🧪 Customer name:', orderManager?.currentOrder?.customerName);
            console.log('🧪 Customer ID:', orderManager?.currentOrder?.customerId);
            
            if (!orderManager?.currentOrder?.customerId) {
                console.log('🧪 No customer selected - attempting auto-selection...');
                
                // Try to select the first test customer
                if (typeof customerDatabase !== 'undefined' && customerDatabase.customers.length > 0) {
                    const firstCustomer = customerDatabase.customers[0];
                    console.log('🧪 About to select customer for dropdown test:', firstCustomer);
                    orderManager.selectCustomer(firstCustomer.id);
                    console.log('🧪 Selected customer:', firstCustomer.name);
                    
                    // Verify the selection worked
                    console.log('🧪 After selection - customerName:', orderManager?.currentOrder?.customerName);
                    console.log('🧪 After selection - customerId:', orderManager?.currentOrder?.customerId);
                    
                    if (!orderManager?.currentOrder?.customerId) {
                        addTestResult('Dropdown Click Test', '❌ Customer auto-selection failed', 'error');
                        return;
                    }
                } else {
                    addTestResult('Dropdown Click Test', '❌ No customers available for auto-selection', 'error');
                    return;
                }
            } else {
                console.log('🧪 Customer already selected for dropdown test:', orderManager.currentOrder.customerName);
            }
            
            // First trigger a product search to show dropdown
            const productInput = document.getElementById('product-search');
            productInput.value = 'KP';
            productInput.focus();
            
            // Wait for customer selection to process, then trigger product search
            setTimeout(() => {
                console.log('🧪 Final check before dropdown test input event:');
                console.log('🧪 Final customerName:', orderManager?.currentOrder?.customerName);
                console.log('🧪 Final customerId:', orderManager?.currentOrder?.customerId);
                
                // Trigger input event to show dropdown
                const inputEvent = new Event('input', { bubbles: true });
                productInput.dispatchEvent(inputEvent);
                
                // Wait a bit for dropdown to appear, then try to click first item
                setTimeout(() => {
                    const searchResults = document.getElementById('search-results');
                    console.log('🧪 Search results container:', searchResults);
                    console.log('🧪 Search results innerHTML:', searchResults.innerHTML);
                    
                    const firstProductItem = searchResults.querySelector('.product-result');
                    console.log('🧪 First product item found:', firstProductItem);
                    
                    if (firstProductItem) {
                        console.log('🧪 About to simulate click on:', firstProductItem);
                        console.log('🧪 Product item dataset:', firstProductItem.dataset);
                        
                        // Simulate click
                        const clickEvent = new MouseEvent('click', {
                            bubbles: true,
                            cancelable: true,
                            view: window
                        });
                        
                        firstProductItem.dispatchEvent(clickEvent);
                        addTestResult('Dropdown Click Test', '✅ Simulated click on first product item', 'success');
                    } else {
                        addTestResult('Dropdown Click Test', '❌ No product items found in dropdown', 'error');
                    }
                }, 500);
            }, 100);
        }

        function testAddItem() {
            console.log('🧪 Test: Attempting to add item');
            console.log('🧪 Test: selectedProduct =', orderManager?.selectedProduct);
            console.log('🧪 Test: currentOrder.customerId =', orderManager?.currentOrder?.customerId);
            
            if (!orderManager) {
                addTestResult('OrderManager', 'Not initialized', 'error');
                return;
            }
            
            if (!orderManager.selectedProduct) {
                addTestResult('Product Selection', 'No product selected - this should show validation error', 'error');
                // Try to call addItem to see validation behavior
                try {
                    orderManager.addItem();
                } catch (e) {
                    addTestResult('Add Item Error', e.message, 'error');
                }
                return;
            }
            
            if (!orderManager.currentOrder.customerId) {
                addTestResult('Customer Selection', 'No customer selected', 'error');
                return;
            }
            
            addTestResult('Add Item Test', 'All validations should pass!', 'success');
            try {
                orderManager.addItem();
                addTestResult('Add Item Result', 'Success - item should be added to order', 'success');
            } catch (e) {
                addTestResult('Add Item Error', e.message, 'error');
            }
        }
        
        // Add test customer data
        function ensureTestData() {
            console.log('🔧 Ensuring test data is available...');
            
            // Check if customerDatabase exists and initialize if needed
            if (typeof customerDatabase !== 'undefined') {
                console.log('🔧 CustomerDatabase found, current customers:', customerDatabase.customers.length);
                
                // Always add test customers for the test environment
                const testCustomers = [
                    {
                        id: 'TEST_CUSTOMER_001',
                        name: 'Kerem Test',
                        code: 'KT001',
                        email: 'kerem@test.com',
                        phone: '+90 555 123 4567',
                        orderCount: 1,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'TEST_CUSTOMER_002', 
                        name: 'Ayşe Müşteri',
                        code: 'AM002',
                        email: 'ayse@test.com',
                        phone: '+90 555 987 6543',
                        orderCount: 3,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'TEST_CUSTOMER_003',
                        name: 'Mehmet Özkan',
                        code: 'MO003', 
                        email: 'mehmet@test.com',
                        phone: '+90 555 111 2233',
                        orderCount: 0,
                        createdAt: new Date().toISOString()
                    }
                ];
                
                // Clear existing and add test customers
                customerDatabase.customers = testCustomers;
                localStorage.setItem('customerDatabase', JSON.stringify(customerDatabase.customers));
                
                addTestResult('Test Customer Data', `✅ Added ${testCustomers.length} test customers`, 'success');
                console.log('🔧 Test customers added:', testCustomers.map(c => c.name));
            } else {
                addTestResult('Test Customer Data', '❌ CustomerDatabase not available', 'error');
            }
            
            // Check product database with more detailed logging
            if (typeof productDatabase !== 'undefined') {
                console.log('🔧 ProductDatabase found');
                console.log('🔧 ProductDatabase object:', productDatabase);
                console.log('🔧 Current products count:', productDatabase.products.length);
                console.log('🔧 Product list:', productDatabase.products);
                
                if (productDatabase.products.length > 0) {
                    addTestResult('Test Product Data', `✅ ${productDatabase.products.length} products available`, 'success');
                    
                    // Test the search function
                    const testResult = productDatabase.getProductSuggestions('KP');
                    console.log('🔧 Test search for "KP":', testResult);
                    addTestResult('Product Search Function', `✅ Search for "KP" returns ${testResult.length} results`, 'success');
                } else {
                    addTestResult('Test Product Data', '⚠️ ProductDatabase loaded but empty - may still be loading', 'error');
                    
                    // Try to force load fallback data
                    if (typeof productDatabase.loadFallbackProducts === 'function') {
                        console.log('🔧 Forcing fallback product load...');
                        productDatabase.loadFallbackProducts();
                        addTestResult('Fallback Load', `✅ Forced fallback load - now ${productDatabase.products.length} products`, 'success');
                    }
                }
            } else {
                addTestResult('Test Product Data', '❌ ProductDatabase not available', 'error');
            }
        }

        // Initialize form synchronization
        function initializeForm() {
            // Sync visible quantity with hidden quantity
            const quantityVisible = document.getElementById('quantity-visible');
            const quantityHidden = document.getElementById('quantity');
            if (quantityVisible && quantityHidden) {
                quantityHidden.value = quantityVisible.value;
            }
            
            // Sync visible notes with hidden notes  
            const notesVisible = document.getElementById('item-notes-visible');
            const notesHidden = document.getElementById('item-notes');
            if (notesVisible && notesHidden) {
                notesHidden.value = notesVisible.value;
            }
        }

        // Wait for scripts to load then run tests
        setTimeout(() => {
            updateStatus('Testing script loading...', 'info');
            
            // Initialize form synchronization
            initializeForm();
            
            // Ensure we have test data
            ensureTestData();
            
            // Test 1: Check if objects exist
            if (typeof orderManager !== 'undefined') {
                addTestResult('OrderManager', '✅ Loaded successfully', 'success');
            } else {
                addTestResult('OrderManager', '❌ Failed to load', 'error');
                updateStatus('Critical error: OrderManager not loaded', 'error');
                return;
            }
            
            if (typeof productDatabase !== 'undefined') {
                addTestResult('ProductDatabase', '✅ Loaded successfully', 'success');
            } else {
                addTestResult('ProductDatabase', '❌ Failed to load', 'error');
            }
            
            if (typeof customerDatabase !== 'undefined') {
                addTestResult('CustomerDatabase', '✅ Loaded successfully', 'success');
            } else {
                addTestResult('CustomerDatabase', '❌ Failed to load', 'error');
            }
            
            // Test 2: Check event delegation setup
            const productResults = document.getElementById('search-results');
            const customerResults = document.getElementById('customer-search-results');
            
            if (productResults && customerResults) {
                addTestResult('Search Containers', '✅ Both containers found', 'success');
            } else {
                addTestResult('Search Containers', '❌ Missing containers', 'error');
            }
            
            // Test 3: Check if methods exist
            if (typeof orderManager.selectProductFromSearch === 'function') {
                addTestResult('selectProductFromSearch', '✅ Method exists', 'success');
            } else {
                addTestResult('selectProductFromSearch', '❌ Method missing', 'error');
            }
            
            if (typeof orderManager.selectCustomer === 'function') {
                addTestResult('selectCustomer', '✅ Method exists', 'success');
            } else {
                addTestResult('selectCustomer', '❌ Method missing', 'error');
            }
            
            updateStatus('✅ Test environment ready! Try typing to search for customers and products.', 'success');
            
        }, 2000);
        
        // Delayed check for product database (in case it's still loading)
        setTimeout(() => {
            if (typeof productDatabase !== 'undefined' && productDatabase.products.length === 0) {
                addTestResult('Delayed Product Check', '⚠️ Product database still empty after 5 seconds', 'error');
                
                // Force fallback load one more time
                if (typeof productDatabase.loadFallbackProducts === 'function') {
                    console.log('🔧 Final attempt to load fallback products...');
                    productDatabase.loadFallbackProducts();
                    addTestResult('Final Fallback Load', `✅ Final fallback - now ${productDatabase.products.length} products`, productDatabase.products.length > 0 ? 'success' : 'error');
                }
            } else if (typeof productDatabase !== 'undefined' && productDatabase.products.length > 0) {
                addTestResult('Delayed Product Check', `✅ Product database working - ${productDatabase.products.length} products loaded`, 'success');
            }
        }, 5000);
    </script>
</body>
</html>