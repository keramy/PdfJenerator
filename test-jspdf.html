<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jsPDF Loading Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading { background-color: #d1ecf1; color: #0c5460; border: 1px solid #b8daff; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>jsPDF Loading Test</h1>
    <div id="status"></div>
    
    <button onclick="testJsPDFLoading()">Test jsPDF Loading</button>
    <button onclick="testPDFGeneration()">Test PDF Generation</button>
    
    <script>
        // Enhanced jsPDF loading with improved detection
        window.jsPDFLoadAttempts = 0;
        window.jsPDFLoadingPromise = null;
        
        function checkJsPDFLoaded() {
            // Check multiple possible locations for jsPDF
            return (typeof window.jsPDF !== 'undefined') || 
                   (typeof window.jspdf !== 'undefined') ||
                   (window.jspdf && window.jspdf.jsPDF);
        }
        
        function getJsPDFConstructor() {
            if (window.jsPDF) return window.jsPDF;
            if (window.jspdf && window.jspdf.jsPDF) return window.jspdf.jsPDF;
            if (typeof jsPDF !== 'undefined') return jsPDF;
            return null;
        }
        
        function loadJsPDF() {
            if (window.jsPDFLoadingPromise) {
                return window.jsPDFLoadingPromise;
            }
            
            window.jsPDFLoadingPromise = new Promise((resolve, reject) => {
                if (checkJsPDFLoaded()) {
                    console.log('jsPDF already loaded successfully');
                    resolve(getJsPDFConstructor());
                    return;
                }
                
                window.jsPDFLoadAttempts++;
                console.log('Attempting to load jsPDF, attempt:', window.jsPDFLoadAttempts);
                
                const cdnUrls = [
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js',
                    'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
                    'js/lib/jspdf.min.js' // Local fallback
                ];
                
                function tryLoadScript(urlIndex) {
                    if (urlIndex >= cdnUrls.length) {
                        console.error('All jsPDF CDNs failed to load');
                        reject(new Error('All jsPDF CDNs failed'));
                        return;
                    }
                    
                    const script = document.createElement('script');
                    script.src = cdnUrls[urlIndex];
                    script.onload = function() {
                        console.log('jsPDF loaded successfully from:', script.src);
                        // Wait a bit for the library to initialize
                        setTimeout(() => {
                            if (checkJsPDFLoaded()) {
                                resolve(getJsPDFConstructor());
                            } else {
                                console.log('jsPDF script loaded but constructor not found, trying next URL');
                                tryLoadScript(urlIndex + 1);
                            }
                        }, 100);
                    };
                    script.onerror = function() {
                        console.log('Failed to load jsPDF from:', script.src);
                        tryLoadScript(urlIndex + 1);
                    };
                    document.head.appendChild(script);
                }
                
                tryLoadScript(0);
            });
            
            return window.jsPDFLoadingPromise;
        }
        
        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        async function testJsPDFLoading() {
            showStatus('Testing jsPDF loading...', 'loading');
            
            try {
                const jsPDFConstructor = await loadJsPDF();
                if (jsPDFConstructor) {
                    showStatus('✅ jsPDF loaded successfully!', 'success');
                } else {
                    showStatus('❌ jsPDF constructor not found', 'error');
                }
            } catch (error) {
                showStatus(`❌ Failed to load jsPDF: ${error.message}`, 'error');
            }
        }
        
        async function testPDFGeneration() {
            showStatus('Testing PDF generation...', 'loading');
            
            try {
                const jsPDFConstructor = await loadJsPDF();
                if (!jsPDFConstructor) {
                    throw new Error('jsPDF not available');
                }
                
                const doc = new jsPDFConstructor();
                doc.text('Test PDF Generation', 20, 20);
                doc.text('This is a test to verify jsPDF is working correctly.', 20, 30);
                doc.text('Generated at: ' + new Date().toLocaleString(), 20, 40);
                doc.save('test-jspdf.pdf');
                
                showStatus('✅ PDF generated successfully!', 'success');
            } catch (error) {
                showStatus(`❌ PDF generation failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-test on load
        window.addEventListener('load', testJsPDFLoading);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" onerror="console.log('Primary CDN failed, fallback system will handle loading')"></script>
</body>
</html>